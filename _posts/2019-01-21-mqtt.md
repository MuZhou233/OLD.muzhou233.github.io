---
layout: post
title: STM8-MQTT-WXAPP
date: 2019-01-21
categories: blog
tags: [blog]
description:
---

## 从MQTT说起

MQTT是一个构建在TCP/IP上的通讯协议，它的特点是数据包小且容易构建容易解析，协议本身也十分简单。由于协议对硬件资源消耗极少，所以MQTT是一个适合使用在低功耗物联网平台上的通讯协议。  
对于STM8/STM32主控来说，只需要一个已经与MQTT服务器建立TCP连接的接口（通过WIFI模块或蓝牙模块预配置，我使用的是接在i2c接口上的已经开启透传模式的WIFI模块），就可以通过简单的字符串生成和解析来和服务器通讯。  
下面简单介绍了一下MQTT协议的具体内容，自己实现并不难，当然也有开源的各种语言的MQTT库供大家使用。  

### 协议关键词

**订阅（Subscription）**  
订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

**会话（Session）**  
每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

**主题名（Topic Name）**  
连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

**主题筛选器（Topic Filter）**  
一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

**服务质量（QOS）**  
最多一次，这一级别会发生消息丢失或重复，消息发布依赖于底层TCP/IP网络。即：<=1  
至多一次，这一级别会确保消息到达，但消息可能会重复。即：>=1  
只有一次，确保消息只有一次到达。即：＝1。在一些要求比较严格的计费系统中，可以使用此级别  

**负载（Payload）**  
消息订阅者所具体接收的内容

**消息代理（Broker）**  
MQTT协议的中心服务器/应用需要完成以下任务  
接受来自客户的网络连接  
接受客户发布的应用信息  
处理来自客户端的订阅和退订请求  
向订阅的客户转发应用程序消息  

### 包组成

一个MQTT数据包由三部分构成：
1. 固定头（Fixed header）存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识
2. 可变头（Variable header）存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容
3. 消息体（payload）存在于部分MQTT数据包中，表示客户端收到的具体内容

#### MQTT固定头
固定头存在于所有MQTT数据包中，其结构如下：

|Bit|7  6   5   4|3 2   1   0|
|:---|---:|:---|
|byte 1|MQTT数据包类型|不同类型MQTT数据包的具体标识|
|byte 2…|剩余|长度|

##### MQTT数据包类型
位置：byte 1, bits 7-4。

相于一个4位的无符号值，类型如下：

|名称|值|流方向|描述|
|---|---|---|---|
|Reserved|0|不可用|保留位|
|CONNECT|1|客户端到服务器|客户端请求连接到服务器|
|CONNACK|2|服务器到客户端|连接确认|
|PUBLISH|3|双向|发布消息|
|PUBACK|4|双向|发布确认|
|PUBREC|5|双向|发布收到（保证第1部分到达）|
|PUBREL|6|双赂|发布释放（保证第2部分到达）|
|PUBCOMP|7|双向|发布完成（保证第3部分到达）|
|SUBSCRIBE|8|客户端到服务器|客户端请求订阅|
|SUBACK|9|服务器到客户端|订阅确认|
|UNSUBSCRIBE|10|客户端到服务器|请求取消订阅|
|UNSUBACK|11|服务器到客户端|取消订阅确认|
|PINGREQ|12|客户端到服务器|PING请求|
|PINGRESP|13|服务器到客户端|PING应答|
|DISCONNECT|14|客户端到服务器|中断连接|
|Reserved|15|不可用|保留位|

##### 标识位
位置：byte 1, bits 3-0。

在不使用标识位的消息类型中，标识位被做为保留位。如果收到无效的标志时，接收端必须关闭网络连接：

|数据包|标识位|Bit 3|Bit 2|Bit 1|Bit 0|
|---|---|---|---|---|---|
|CONNECT|保留位|0|0|0|0|
|CONNACK|保留位|0|0|0|0|
|PUBLISH|MQTT 3.1.1使用|DUP1|QoS2|QoS2|RETAIN3|
|PUBACK|保留位|0|0|0|0|
|PUBREC|保留位|0|0|0|0|
|PUBREL|保留位|0|0|1|0|
|PUBCOMP|保留位|0|0|0|0|
|SUBSCRIBE|保留位|0|0|1|0|
|SUBACK|保留位|0|0|0|0|
|UNSUBSCRIBE|保留位|0|0|1|0|
|UNSUBACK|保留位|0|0|0|0|
|PINGREQ|保留位|0|0|0|0|
|PINGRESP|保留位|0|0|0|0|
|DISCONNECT|保留位|0|0|0|0|

- DUP：发布消息的副本。用来在保证消息的可靠传输，如果设置为 1，则在下面的变长中增加
MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。
- QoS：发布消息的服务质量，即：保证消息传递的次数
    - 00：最多一次，即：<=1
    - 01：至少一次，即：>=1
    - 10：一次，即：=1
    - 11：预留
- RETAIN： 发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。


##### 剩余长度（Remaining Length）
位置：byte 1。

固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。当最后一位为 1时，表示长度不足，需要使用二个字节继续保存。 例如：计算出后面的大小为0


#### MQTT可变头
MQTT数据包中包含一个可变头，它驻位于固定的头和负载之间。可变头的内容因数据包类型而不同，较常的应用是做为包的标识：

|Bit|7 6 5 4 3 2 1 0|
|---|---|
|byte 1|包标签符（MSB）|
|byte 2…|包标签符（LSB）|

很多类型数据包中都包括一个2字节的数据包标识字段，这些类型的包有：PUBLISH (QoS > 0)、PUBACK、PUBREC、PUBREL、PUBCOMP、SUBSCRIBE、SUBACK、UNSUBSCRIBE、UNSUBACK


#### Payload消息体
Payload消息体位MQTT数据包的第三部分，CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息 有消息体：

- CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。
- SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。
- SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。
- UNSUBSCRIBE，消息体内容是要订阅的主题。